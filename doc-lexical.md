# Lexical 编辑器重构待办列表

## 项目概述
将当前的 markdown 编辑器重构为 Lexical 富文本编辑器，暂时忽略 JavaScript 和 TypeScript 代码块功能，专注于完善基础编辑器功能。

## 阶段一：环境准备和依赖安装

### 1.1 安装 Lexical 核心依赖
- [x] 安装 `lexical` 核心包
- [x] 安装 `@lexical/rich-text` 富文本插件
- [x] 安装 `@lexical/list` 列表插件
- [x] 安装 `@lexical/link` 链接插件
- [x] 安装 `@lexical/table` 表格插件
- [x] 安装 `@lexical/code` 代码块插件
- [x] 安装 `@lexical/selection` 选择插件
- [x] 安装 `@lexical/history` 历史记录插件
- [x] 安装 `@lexical/clipboard` 剪贴板插件
- [x] 安装 `@lexical/file` 文件处理插件
- [x] 安装 `@lexical/html` HTML 转换插件
- [x] 安装 `@lexical/markdown` Markdown 转换插件
- [x] 安装 `@lexical/utils` 工具包
- [ ] 安装主题相关依赖（需要研究 Lexical 主题实现方式）

### 1.2 自定义 Vue 集成实现
- [x] 研究 Lexical 核心 API 和生命周期
- [x] 设计 Vue 3 Composition API 集成方案
- [x] 实现 Vue 组件与 Lexical 编辑器的桥接
- [x] 创建自定义的 Vue-Lexical 适配层
- [x] 实现响应式数据绑定
- [x] 处理编辑器状态同步
- [x] 实现事件系统集成

### 1.3 移除不需要的依赖
- [ ] 移除 `@codemirror/lang-markdown`
- [ ] 移除 `@codemirror/state`
- [ ] 移除 `@codemirror/theme-one-dark`
- [ ] 移除 `@codemirror/view`
- [ ] 移除 `markdown-it` 相关包
- [ ] 移除 `markdown-it-*` 插件包

## 阶段二：核心架构重构

### 2.1 重构数据模型
- [ ] 修改 `CodeBlock` 接口，将 `type` 改为 `'lexical'`
- [ ] 更新 `content` 字段类型为 Lexical 编辑器状态
- [ ] 添加 Lexical 编辑器配置接口
- [ ] 更新 store 中的相关方法

### 2.2 创建自定义 Vue-Lexical 集成
- [x] 创建 `useLexicalEditor` composable
- [x] 实现 Lexical 编辑器实例管理
- [x] 创建 `LexicalEditor.vue` 组件
- [x] 实现 Vue 组件与 Lexical 的双向绑定
- [x] 配置主题和样式
- [x] 修复编辑器无法输入的问题
- [x] 按照官方文档完善实现
- [ ] 实现工具栏功能
- [ ] 添加快捷键支持
- [x] 实现编辑器配置管理
- [x] 处理编辑器生命周期
- [x] 实现插件系统集成（基础版本）

### 2.3 重构主内容组件
- [ ] 修改 `MainContent.vue` 组件
- [ ] 移除 JavaScript/TypeScript 相关功能
- [ ] 简化工具栏，只保留 Lexical 编辑器相关功能
- [ ] 更新空状态显示

## 阶段三：编辑器功能实现

### 3.1 基础编辑功能
- [ ] 文本输入和编辑
- [ ] 文本格式化（粗体、斜体、下划线）
- [ ] 文本对齐（左对齐、居中、右对齐）
- [ ] 字体大小调整
- [ ] 文本颜色设置

### 3.2 块级元素支持
- [ ] 标题（H1-H6）
- [ ] 段落
- [ ] 列表（有序、无序）
- [ ] 引用块
- [ ] 代码块
- [ ] 分割线

### 3.3 高级功能
- [ ] 链接插入和编辑
- [ ] 图片插入
- [ ] 表格创建和编辑
- [ ] 撤销/重做功能
- [ ] 复制/粘贴功能
- [ ] 查找/替换功能

### 3.4 工具栏实现
- [ ] 格式化工具栏
- [ ] 插入工具栏
- [ ] 视图工具栏
- [ ] 工具栏响应式设计

## 阶段四：数据持久化和导入导出

### 4.1 数据格式设计
- [ ] 设计 Lexical 编辑器状态序列化格式
- [ ] 实现 JSON 格式的文档存储
- [ ] 支持 HTML 导出
- [ ] 支持 Markdown 导出

### 4.2 文件操作
- [ ] 实现文档保存功能
- [ ] 实现文档加载功能
- [ ] 实现文档导出功能
- [ ] 实现自动保存功能

### 4.3 版本控制
- [ ] 实现文档版本历史
- [ ] 实现文档比较功能
- [ ] 实现版本回滚功能

## 阶段五：用户体验优化

### 5.1 界面设计
- [ ] 设计现代化的编辑器界面
- [ ] 实现暗色主题支持
- [ ] 优化响应式布局
- [ ] 添加加载状态指示

### 5.2 交互优化
- [ ] 添加快捷键提示
- [ ] 实现拖拽功能
- [ ] 添加右键菜单
- [ ] 实现自动完成功能

### 5.3 性能优化
- [ ] 实现虚拟滚动
- [ ] 优化大文档渲染性能
- [ ] 实现懒加载
- [ ] 添加性能监控

## 阶段六：测试和文档

### 6.1 单元测试
- [ ] 为 Lexical 编辑器组件编写测试
- [ ] 为数据模型编写测试
- [ ] 为工具函数编写测试
- [ ] 更新现有测试用例

### 6.2 集成测试
- [ ] 测试编辑器与 store 的集成
- [ ] 测试文件操作功能
- [ ] 测试数据持久化功能
- [ ] 测试导入导出功能

### 6.3 文档编写
- [ ] 编写 Lexical 编辑器使用文档
- [ ] 编写 API 文档
- [ ] 编写开发指南
- [ ] 更新 README 文件

## 阶段七：清理和优化

## 技术实现细节

### Vue-Lexical 集成架构

#### 核心组件设计
```typescript
// useLexicalEditor.ts
interface LexicalEditorConfig {
  namespace: string
  theme: EditorTheme
  nodes: LexicalNode[]
  onError: (error: Error) => void
}

interface UseLexicalEditorReturn {
  editor: Ref<LexicalEditor | null>
  isEditable: Ref<boolean>
  content: Ref<string>
  updateContent: (newContent: string) => void
  focus: () => void
  blur: () => void
  destroy: () => void
}
```

#### 组件结构
```
src/renderer/src/
├── composables/
│   └── useLexicalEditor.ts          # Lexical 编辑器核心逻辑
├── components/
│   ├── LexicalEditor.vue            # 主编辑器组件
│   ├── LexicalToolbar.vue           # 工具栏组件
│   └── LexicalContent.vue           # 内容渲染组件
├── utils/
│   ├── lexicalConfig.ts             # 编辑器配置
│   ├── lexicalTheme.ts              # 主题配置
│   └── lexicalUtils.ts              # 工具函数
└── types/
    └── lexical.d.ts                 # 类型定义
```

#### 关键实现要点
1. **生命周期管理**：确保编辑器实例在组件挂载时创建，卸载时销毁
2. **响应式绑定**：实现 Vue 的响应式系统与 Lexical 状态的双向同步
3. **事件处理**：正确处理编辑器的各种事件并转换为 Vue 事件
4. **性能优化**：避免不必要的重新渲染和状态更新

#### 根据官方文档的改进
1. **编辑器更新监听器优化**：使用 `editorStateToText()` 工具函数，将编辑器状态转换为可读的文本内容
2. **内容序列化工具**：新增 `lexicalUtils.ts` 工具文件，支持 Markdown 格式转换
3. **代码结构优化**：分离关注点，将内容处理逻辑从 composable 中分离到工具函数
4. **错误处理改进**：在内容转换过程中添加了错误处理和降级处理
5. **插件注册修复**：按照官方示例正确注册 `registerRichText` 和 `registerHistory` 插件
   - 使用 `mergeRegister` 来合并多个插件注册
   - 添加了历史记录支持，支持撤销/重做功能
   - 注册了 `HeadingNode` 和 `QuoteNode` 节点类型
6. **编辑器配置完善**：添加了节点注册和主题配置
   - 在编辑器配置中注册了必要的节点类型
   - 添加了主题配置支持
   - 修复了编辑器无法输入的核心问题
7. **基础功能测试**：创建了独立的 Lexical 编辑器测试
   - 创建了 `lexicalSimpleTest.ts` 用于基础功能验证
   - 创建了 `LexicalBasicTest.vue` 组件用于界面测试
   - 提供了控制台测试接口，方便调试
8. **窗口配置优化**：调整 Electron 窗口默认配置
   - 设置窗口默认尺寸为 1920x1080
   - 添加窗口最大化确保占满屏幕
   - 优化容器样式使其占满整个窗口

### 7.1 代码清理
- [ ] 移除不再使用的代码
- [ ] 清理注释和调试代码
- [ ] 优化代码结构
- [ ] 更新 TypeScript 类型定义

### 7.2 依赖优化
- [ ] 清理未使用的依赖
- [ ] 更新依赖版本
- [ ] 优化打包配置
- [ ] 减少包大小

### 7.3 最终测试
- [ ] 进行全面功能测试
- [ ] 进行性能测试
- [ ] 进行兼容性测试
- [ ] 修复发现的问题

## 注意事项

### 技术考虑
1. **Lexical 学习曲线**：Lexical 是一个相对较新的编辑器框架，需要时间学习和适应
2. **自定义 Vue 集成**：需要自己实现 Vue 3 与 Lexical 的集成，增加了技术复杂度
3. **性能考虑**：富文本编辑器可能比 markdown 编辑器更消耗资源
4. **数据迁移**：需要考虑现有 markdown 数据的迁移方案
5. **维护成本**：自定义集成需要自己维护和更新

### 开发建议
1. **渐进式重构**：建议分阶段进行，每个阶段完成后进行测试
2. **保持功能**：在重构过程中保持基本功能可用
3. **用户反馈**：及时收集用户反馈，调整开发优先级
4. **文档同步**：及时更新相关文档和注释

### 风险评估
1. **技术风险**：Lexical 相对较新，可能存在未知问题
2. **集成风险**：自定义 Vue 集成可能遇到兼容性问题
3. **时间风险**：重构工作量较大，自定义集成增加了开发时间
4. **兼容性风险**：可能与现有功能产生冲突
5. **性能风险**：富文本编辑器可能影响应用性能
6. **维护风险**：自定义集成需要持续维护和更新

## 后续规划

### 短期目标（1-2周）
- 完成环境准备和基础架构重构
- 实现基础编辑功能
- 完成数据模型重构

### 中期目标（3-4周）
- 完成所有编辑器功能实现
- 完成数据持久化功能
- 完成基础测试

### 长期目标（5-6周）
- 完成用户体验优化
- 完成性能优化
- 完成文档编写
- 准备发布

## 总结

这个重构计划将把项目从简单的 markdown 编辑器升级为功能丰富的 Lexical 富文本编辑器。通过自定义 Vue 集成实现，我们可以完全控制编辑器的行为和外观。虽然增加了技术复杂度，但这种方式提供了更大的灵活性和定制能力。通过分阶段实施，可以确保项目的稳定性和功能的完整性。重构完成后，用户将获得更强大的编辑体验，同时为后续功能扩展奠定基础。
